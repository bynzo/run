<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exercise History</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f9fc;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    main {
      width: 90%;
      max-width: 1000px;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
    }
    th, td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
      white-space: nowrap;
    }
    th {
      background-color: #f2f2f2;
      font-weight: 600;
    }
    .nav-button {
      display: inline-block;
      padding: 10px;
      background: #2575fc;
      color: white;
      border-radius: 6px;
      text-align: center;
      font-weight: 600;
      transition: background 0.3s ease;
      text-decoration: none;
      border: none;
      cursor: pointer;
    }
    .nav-button:hover {
      background: #1a5bcc;
    }
    #routeView {
      display: none;
      margin-top: 20px;
    }
    #map {
      width: 100%;
      height: 300px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    footer {
      width: 100%;
      text-align: center;
      padding: 10px;
      margin-bottom: 10px;
      color: #666;
    }
  </style>
</head>
<body>
  <header><h1>Past Running Exercises</h1></header>
  <main>
    <div class="table-container">
      <table id="exercisesTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Duration (s)</th>
            <th>Distance (km)</th>
            <th>Avg Speed</th>
            <th>Max Speed</th>
            <th>Min Speed</th>
            <th>Type</th>
            <th>Weather</th>
            <th>Route</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="display: flex; justify-content: space-between; gap: 20px;">
      <a class="nav-button" href="index.html">Back to Tracker</a>
      <a class="nav-button" href="stats.html">View Statistics</a>
    </div>
    <div id="routeView">
      <div id="map"></div>
      <button class="nav-button" onclick="closeRoute()">Close</button>
    </div>
  </main>
  <footer>Running Tracker 2025 v0.2</footer>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const exercises = JSON.parse(localStorage.getItem('exercises')) || [];
    const tableBody = document.querySelector('#exercisesTable tbody');

    exercises.forEach((exercise, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${exercise.date}</td>
        <td>${exercise.duration}</td>
        <td>${exercise.distance}</td>
        <td>${exercise.avgSpeed}</td>
        <td>${exercise.maxSpeed}</td>
        <td>${exercise.minSpeed}</td>
        <td>${exercise.exerciseType || 'N/A'}</td>
        <td>${exercise.weather ? `${exercise.weather.description}, ${exercise.weather.temperature}°C` : 'N/A'}</td>
        <td><button class="nav-button" style="padding:6px 10px; font-size: 14px;" onclick="viewRoute(${index})">View</button></td>
      `;
      tableBody.appendChild(tr);
    });

    let map;
    function viewRoute(index) {
      const exercise = exercises[index];
      if (!exercise || !exercise.positions || exercise.positions.length === 0) {
        alert("No route data available for this exercise.");
        return;
      }

      const routeViewDiv = document.getElementById('routeView');
      routeViewDiv.style.display = 'block';

      const mapContainer = document.getElementById('map');
      mapContainer.innerHTML = ""; // clear previous map
      if (mapContainer._leaflet_id) {
        mapContainer._leaflet_id = null;
      }

      map = L.map('map').setView([0, 0], 13);

      L.tileLayer('https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}', {
        attribution: '© Google Maps',
        maxZoom: 20
      }).addTo(map);

      const latlngs = exercise.positions.map(p => [p.coords.latitude, p.coords.longitude]);
      const polyline = L.polyline(latlngs, { color: 'red' }).addTo(map);

      L.marker(latlngs[0]).addTo(map).bindPopup("Start");
      L.marker(latlngs[latlngs.length - 1]).addTo(map).bindPopup("Finish");

      map.fitBounds(polyline.getBounds());
    }

    function closeRoute() {
      document.getElementById('routeView').style.display = 'none';
    }
  </script>
</body>
</html>
