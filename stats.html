<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Running Tracker - Statistics</title>
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Montserrat', sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f9fc;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #6a11cb, #2575fc);
      color: white;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    main {
      width: 90%;
      max-width: 800px;
      margin: 20px 0;
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .chart-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 10px;
    }
    .toggle-btns {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .toggle-btns button {
      padding: 10px 15px;
      background: #2575fc;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .toggle-btns button:hover {
      background: #1a5bcc;
    }
    canvas {
      min-width: 600px;
      height: 300px !important;
    }
    .stats-summary {
      margin-bottom: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .stats-summary table {
      width: 100%;
      border-collapse: collapse;
    }
    .stats-summary th, .stats-summary td {
      padding: 8px;
      border: 1px solid #ccc;
      text-align: left;
    }
    .nav-button, button.button {
      display: inline-block;
      padding: 8px 12px;
      background: #2575fc;
      color: white;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 600;
      transition: background 0.3s ease;
      border: none;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .nav-button:hover, button.button:hover {
      background: #1a5bcc;
    }
    footer {
      width: 100%;
      text-align: center;
      padding: 10px;
      margin-bottom: 10px;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>Exercise Statistics</h1>
  </header>
  <main>
    <div style="margin-bottom: 20px;">
      <a class="nav-button" href="index.html">Tracker</a>
      <a class="nav-button" href="history.html">History</a>
    </div>

    <h2>Exercise Duration per Day</h2>
    <div class="toggle-btns">
      <button onclick="renderChart('duration', 'week')">Week View</button>
      <button onclick="renderChart('duration', 'month')">Month View</button>
    </div>
    <div class="chart-container">
      <canvas id="durationChart"></canvas>
    </div>

    <h2>Exercise Distance per Day</h2>
    <div class="toggle-btns">
      <button onclick="renderChart('distance', 'week')">Week View</button>
      <button onclick="renderChart('distance', 'month')">Month View</button>
    </div>
    <div class="chart-container">
      <canvas id="distanceChart"></canvas>
    </div>

    <h2>Overall Statistics</h2>
    <div class="stats-summary">
      <table>
        <tr><th>Total Runs</th><td id="totalRuns">0</td></tr>
        <tr><th>Total Distance (km)</th><td id="totalDistance">0</td></tr>
        <tr><th>Total Duration (hrs)</th><td id="totalDuration">0</td></tr>
        <tr><th>Average Speed (km/h)</th><td id="averageSpeed">0</td></tr>
        <tr><th>Max Speed (km/h)</th><td id="maxSpeedOverall">0</td></tr>
        <tr><th>Min Speed (km/h)</th><td id="minSpeedOverall">0</td></tr>
      </table>
    </div>
  </main>
  <footer>Running Tracker 2025 v0.2</footer>
  <script>
    const exercises = JSON.parse(localStorage.getItem('exercises')) || [];
    const durationCtx = document.getElementById('durationChart').getContext('2d');
    const distanceCtx = document.getElementById('distanceChart').getContext('2d');
    let durationChart, distanceChart;

    function getPeriodKey(date, mode) {
      let parsedDate;
      try {
        parsedDate = new Date(date);
        if (isNaN(parsedDate.getTime())) throw new Error('Invalid date');
      } catch (e) {
        parsedDate = new Date(); // fallback to now
      }
      return parsedDate.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function groupData(mode, type) {
      const data = {};
      exercises.forEach(ex => {
        const key = getPeriodKey(ex.date, mode);
        if (!key) return;
        if (!data[key]) data[key] = {};
        const exType = ex.exerciseType || 'Unknown';
        if (!data[key][exType]) data[key][exType] = 0;
        if (type === 'duration') {
          data[key][exType] += (parseFloat(ex.duration) || 0) / 3600;
        } else {
          data[key][exType] += parseFloat(ex.distance) || 0;
        }
      });
      return data;
    }

    function renderChart(type, mode) {
      const data = groupData(mode, type);
      const labels = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
      const allTypes = new Set();
      labels.forEach(k => Object.keys(data[k]).forEach(t => allTypes.add(t)));

      const datasets = Array.from(allTypes).map(exType => ({
        label: exType,
        data: labels.map(k => data[k][exType] || 0),
        backgroundColor: '#' + Math.floor(Math.random() * 16777215).toString(16)
      }));

      const config = {
        type: 'bar',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: `${type === 'duration' ? 'Duration (hrs)' : 'Distance (km)'} by ${mode}` } },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      };

      if (type === 'duration') {
        if (durationChart) durationChart.destroy();
        durationChart = new Chart(durationCtx, config);
      } else {
        if (distanceChart) distanceChart.destroy();
        distanceChart = new Chart(distanceCtx, config);
      }
    }

    function loadStats() {
      document.getElementById('totalRuns').textContent = exercises.length;
      let totalDist = 0, totalDur = 0, totalSpeed = 0, max = 0, min = Infinity;
      exercises.forEach(ex => {
        const dist = parseFloat(ex.distance);
        const dur = parseFloat(ex.duration);
        totalDist += dist;
        totalDur += dur;
        const speed = (dist / dur) * 3.6;
        totalSpeed += speed;
        if (parseFloat(ex.maxSpeed) > max) max = parseFloat(ex.maxSpeed);
        if (parseFloat(ex.minSpeed) < min) min = parseFloat(ex.minSpeed);
      });
      document.getElementById('totalDistance').textContent = totalDist.toFixed(2);
      document.getElementById('totalDuration').textContent = (totalDur / 3600).toFixed(2);
      document.getElementById('averageSpeed').textContent = (totalSpeed / exercises.length).toFixed(2);
      document.getElementById('maxSpeedOverall').textContent = max.toFixed(2);
      document.getElementById('minSpeedOverall').textContent = min.toFixed(2);
    }

    loadStats();
    renderChart('duration', 'week');
    renderChart('distance', 'week');
  </script>
</body>
</html>
